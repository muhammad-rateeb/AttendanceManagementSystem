@model AttendanceManagementSystem.Models.ViewModels.AttendanceReportViewModel
@{
    ViewData["Title"] = "Attendance Reports";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <h2 class="mb-4"><i class="bi bi-graph-up me-2"></i>Attendance Reports</h2>

    <!-- Filter Form -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filter Reports</h5>
        </div>
        <div class="card-body">
            <form asp-action="Reports" method="get" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Course</label>
                        <select name="CourseId" class="form-select">
                            <option value="">All Courses</option>
                            @if (Model.AvailableCourses != null)
                            {
                                @foreach (var course in Model.AvailableCourses)
                                {
                                    <option value="@course.CourseId" selected="@(Model.Filter?.CourseId == course.CourseId)">
                                        @course.DisplayName
                                    </option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Student</label>
                        <select name="StudentId" class="form-select">
                            <option value="">All Students</option>
                            @if (Model.AvailableStudents != null)
                            {
                                @foreach (var student in Model.AvailableStudents)
                                {
                                    <option value="@student.StudentId" selected="@(Model.Filter?.StudentId == student.StudentId)">
                                        @student.DisplayName
                                    </option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="StartDate" class="form-control" value="@Model.Filter?.StartDate?.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">End Date</label>
                        <input type="date" name="EndDate" class="form-control" value="@Model.Filter?.EndDate?.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search me-1"></i>Filter
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    @if (Model.Summary != null)
    {
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar-check display-4"></i>
                        <h2 class="my-2">@Model.Summary.TotalClasses</h2>
                        <p class="mb-0">Total Classes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-people display-4"></i>
                        <h2 class="my-2">@Model.Summary.TotalStudents</h2>
                        <p class="mb-0">Total Students</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-book display-4"></i>
                        <h2 class="my-2">@Model.Summary.TotalCourses</h2>
                        <p class="mb-0">Total Courses</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-percent display-4"></i>
                        <h2 class="my-2">@Model.Summary.OverallAverageAttendance.ToString("F1")%</h2>
                        <p class="mb-0">Overall Attendance</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Export Buttons -->
    <div class="mb-4">
        <div class="btn-group">
            <a asp-action="ExportReport" asp-route-format="excel" 
               asp-route-courseId="@Model.Filter?.CourseId" 
               asp-route-studentId="@Model.Filter?.StudentId"
               asp-route-startDate="@Model.Filter?.StartDate?.ToString("yyyy-MM-dd")"
               asp-route-endDate="@Model.Filter?.EndDate?.ToString("yyyy-MM-dd")"
               class="btn btn-success">
                <i class="bi bi-file-earmark-excel me-1"></i>Export to Excel
            </a>
            <a asp-action="ExportReport" asp-route-format="pdf" 
               asp-route-courseId="@Model.Filter?.CourseId" 
               asp-route-studentId="@Model.Filter?.StudentId"
               asp-route-startDate="@Model.Filter?.StartDate?.ToString("yyyy-MM-dd")"
               asp-route-endDate="@Model.Filter?.EndDate?.ToString("yyyy-MM-dd")"
               class="btn btn-danger">
                <i class="bi bi-file-earmark-pdf me-1"></i>Export to PDF
            </a>
        </div>
    </div>

    <!-- Student Reports Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Student Attendance Details</h5>
        </div>
        <div class="card-body p-0">
            @if (Model.StudentReports != null && Model.StudentReports.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Reg. Number</th>
                                <th>Student Name</th>
                                <th>Course</th>
                                <th class="text-center">Present</th>
                                <th class="text-center">Absent</th>
                                <th class="text-center">Late</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Percentage</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in Model.StudentReports)
                            {
                                <tr>
                                    <td>@report.RegistrationNumber</td>
                                    <td>@report.StudentName</td>
                                    <td>@report.CourseName</td>
                                    <td class="text-center">
                                        <span class="badge bg-success">@report.PresentCount</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">@report.AbsentCount</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning text-dark">@report.LateCount</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">@report.TotalClasses</span>
                                    </td>
                                    <td class="text-center">
                                        @{
                                            var percentage = report.AttendancePercentage;
                                            var badgeClass = percentage >= 75 ? "bg-success" : percentage >= 50 ? "bg-warning text-dark" : "bg-danger";
                                        }
                                        <span class="badge @badgeClass">@percentage.ToString("F1")%</span>
                                    </td>
                                    <td class="text-center">
                                        @if (report.AttendancePercentage >= 75)
                                        {
                                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Good</span>
                                        }
                                        else if (report.AttendancePercentage >= 50)
                                        {
                                            <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Warning</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Critical</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No attendance records found</h4>
                    <p class="text-muted">Try adjusting your filter criteria</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-submit form when filters change (optional)
        document.querySelectorAll('#filterForm select').forEach(function(select) {
            select.addEventListener('change', function() {
                // Uncomment to enable auto-submit
                // document.getElementById('filterForm').submit();
            });
        });
    </script>
}
